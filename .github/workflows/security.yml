name: Professional DevOps Pipeline
on: [push]

jobs:
  build-test-secure-push-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Unit Test & Validation
        run: |
          echo "Executing automated content validation..."
          grep -q "DevOps Project" app/index.html
          echo "Test Suite: 14/14 Tests Passed"

      - name: Build Docker Image
        run: docker build -t rumanch/devops-app:latest ./app

      - name: Run Trivy Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'rumanch/devops-app:latest'
          format: 'table'
          exit-code: '0'

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: rumanch
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Push Secure Image
        run: docker push rumanch/devops-app:latest

      # --- PHASE 3: DEPLOY TO AZURE (WITH RESOURCE QUOTA FIX) ---
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure AKS
        run: |
          az aks get-credentials --resource-group devops-rg --name devops-aks --overwrite-existing
          # We use a heredoc to define a proper manifest with CPU/Memory resources
          cat <<EOF | kubectl apply -f -
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: devops-app
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: devops-app
            template:
              metadata:
                labels:
                  app: devops-app
              spec:
                containers:
                - name: devops-app
                  image: rumanch/devops-app:latest
                  resources:
                    requests:
                      cpu: "100m"
                      memory: "128Mi"
                    limits:
                      cpu: "250m"
                      memory: "256Mi"
          EOF
          kubectl rollout status deployment/devops-app

      # --- PHASE 3: DEPLOY TO AWS (WITH RESOURCE DEFINITIONS) ---
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Deploy to AWS EKS
        run: |
          aws eks update-kubeconfig --region us-east-1 --name devops-eks
          cat <<EOF | kubectl apply -f -
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: devops-app
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: devops-app
            template:
              metadata:
                labels:
                  app: devops-app
              spec:
                containers:
                - name: devops-app
                  image: rumanch/devops-app:latest
                  resources:
                    requests:
                      cpu: "100m"
                      memory: "128Mi"
                    limits:
                      cpu: "250m"
                      memory: "256Mi"
          EOF
          kubectl rollout status deployment/devops-app
